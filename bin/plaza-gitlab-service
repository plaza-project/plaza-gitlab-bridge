#!/usr/bin/env python3

import logging
import sys
import json
from plaza_service import (
    PlazaService,
    ServiceConfiguration,
    ServiceBlock,
    BlockArgument,
    BlockType,
    FormBasedServiceRegistration,
)
import gitlab

from plaza_gitlab_service import serializers, config
from plaza_gitlab_service.storage import sqlite_storage


class Registerer(FormBasedServiceRegistration):
    def __init__(self, *args, **kwargs):
        FormBasedServiceRegistration.__init__(self, *args, **kwargs)

    def get_call_to_action_text(self, extra_data):
        return """
        Introduce access data for gitlab:

        Gitlab instance: <input name="instance" type="url" value="https://gitlab.com" placeholder="URL for the gitlab instance">
        Access token:    <input name="token" type="text" placeholder="Generated access token">

        See <autolink><value placeholder="your-gitlab-instance" from="instance">/profile/personal_access_tokens</autolink> to get a access token
        """

    async def register(self, data, extra_data):
        print(
            "User {} is registered with: {}".format(
                extra_data.user_id, json.dumps(data["form"], indent=4)
            )
        )

        self.service.register(
            extra_data.user_id, data["form"]["instance"], data["form"]["token"]
        )
        return True


class GitlabService(PlazaService):
    def __init__(self, storage, *args, **kwargs):
        PlazaService.__init__(self, *args, **kwargs)
        self.storage = storage
        self.registerer = Registerer(self)
        self.SUPPORTED_FUNCTIONS = {"get_issues_from_project": self.get_issues}

    def register(self, plaza_user_id, gitlab_instance, gitlab_token):
        print(gitlab_instance)
        gl = gitlab.Gitlab(gitlab_instance, private_token=gitlab_token)
        gl.auth()
        gitlab_user_id = gl.user.attributes["id"]
        username = gl.user.attributes["username"]
        self.storage.register_user(gitlab_user_id, plaza_user_id, gitlab_username=username)

    def get_issues(self, project_id):
        gl = gitlab.Gitlab(GITLAB_INSTANCE, private_token=PRIVATE_TOKEN)
        project = gl.projects.get(project_id)
        return list(map(serializers.serialize_issue, project.issues.list()))

    async def handle_call(self, function_name, arguments, extra_data):
        logging.info(
            "{}({}) # {}".format(
                function_name, ", ".join(arguments), extra_data.user_id
            )
        )
        return self.SUPPORTED_FUNCTIONS[function_name](*arguments)

    def handle_configuration(self):
        return ServiceConfiguration(
            service_name="Gitlab",
            is_public=False,
            registration=self.registerer,
            blocks=[
                ServiceBlock(
                    id="get_issues_from_project",
                    function_name="get_issues",
                    message="Get issues from project %1",
                    arguments=[BlockArgument(type=str, default="kenkeiras/plaza")],
                    block_type=BlockType.GETTER,
                    block_result_type=None,  # TODO: change
                )
            ],
        )


if __name__ == "__main__":
    logging.basicConfig()
    logging.getLogger().setLevel(logging.DEBUG)

    bridge_endpoint = config.get_bridge_endpoint()

    service = GitlabService(sqlite_storage.get_default(), bridge_endpoint)
    service.run()

